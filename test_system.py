#!/usr/bin/env python3
"""
Script de teste para validar o funcionamento do sistema de agentes orquestradores.
"""

import asyncio
import json
import os
import sys
from datetime import datetime
from typing import Dict, Any, List

# Adicionar o diret√≥rio atual ao path para importar m√≥dulos
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from models.schemas import (
    WebhookPayload, 
    ConversationMessage, 
    MessageRole
)
from agents.orchestrator import OrchestratorAgent
from agents.sql_agent import SQLAgent
from services.session_manager import SessionManager


class SystemTester:
    """Classe para testar o sistema de agentes."""
    
    def __init__(self):
        """Inicializa o testador."""
        self.orchestrator = OrchestratorAgent()
        self.sql_agent = SQLAgent()
        self.session_manager = SessionManager()
        self.test_session_id = f"test_session_{int(datetime.now().timestamp())}"
        
        # Resultados dos testes
        self.test_results = {
            "total_tests": 0,
            "passed_tests": 0,
            "failed_tests": 0,
            "test_details": []
        }
    
    def log_test_result(self, test_name: str, success: bool, details: str = ""):
        """Registra o resultado de um teste."""
        self.test_results["total_tests"] += 1
        
        if success:
            self.test_results["passed_tests"] += 1
            status = "‚úÖ PASSOU"
        else:
            self.test_results["failed_tests"] += 1
            status = "‚ùå FALHOU"
        
        result = {
            "test_name": test_name,
            "status": status,
            "success": success,
            "details": details,
            "timestamp": datetime.now().isoformat()
        }
        
        self.test_results["test_details"].append(result)
        print(f"{status}: {test_name}")
        if details:
            print(f"   Detalhes: {details}")
        print()
    
    async def test_session_manager(self):
        """Testa o gerenciador de sess√µes."""
        print("üß™ Testando Session Manager...")
        
        try:
            # Teste 1: Criar sess√£o
            session = await self.session_manager.create_session(self.test_session_id)
            self.log_test_result(
                "Criar sess√£o",
                session.session_id == self.test_session_id,
                f"Session ID: {session.session_id}"
            )
            
            # Teste 2: Adicionar mensagem
            success = await self.session_manager.add_message(
                self.test_session_id,
                MessageRole.USER,
                "Mensagem de teste"
            )
            self.log_test_result(
                "Adicionar mensagem",
                success,
                "Mensagem do usu√°rio adicionada"
            )
            
            # Teste 3: Recuperar hist√≥rico
            history = await self.session_manager.get_conversation_history(self.test_session_id)
            self.log_test_result(
                "Recuperar hist√≥rico",
                len(history) == 1 and history[0].content == "Mensagem de teste",
                f"Hist√≥rico cont√©m {len(history)} mensagens"
            )
            
            # Teste 4: Processar payload
            payload = WebhookPayload(
                session_id=self.test_session_id,
                user_message="Nova mensagem de teste"
            )
            processed_payload = await self.session_manager.process_webhook_payload(payload)
            self.log_test_result(
                "Processar webhook payload",
                len(processed_payload.conversation_history) >= 1,
                f"Payload processado com {len(processed_payload.conversation_history)} mensagens no hist√≥rico"
            )
            
        except Exception as e:
            self.log_test_result(
                "Session Manager (geral)",
                False,
                f"Erro: {str(e)}"
            )
    
    async def test_orchestrator_agent(self):
        """Testa o agente orquestrador."""
        print("üß™ Testando Orchestrator Agent...")
        
        try:
            # Teste 1: An√°lise de inten√ß√£o - Chat geral
            payload = WebhookPayload(
                session_id=self.test_session_id,
                user_message="Ol√°, como voc√™ est√°?",
                conversation_history=[]
            )
            
            intent_analysis = await self.orchestrator.analyze_intent(payload)
            self.log_test_result(
                "An√°lise de inten√ß√£o - Chat geral",
                intent_analysis.intent.value in ["general_chat", "help"],
                f"Inten√ß√£o: {intent_analysis.intent.value}, Confian√ßa: {intent_analysis.confidence}"
            )
            
            # Teste 2: An√°lise de inten√ß√£o - Consulta SQL
            payload.user_message = "Quantos usu√°rios temos no sistema?"
            intent_analysis = await self.orchestrator.analyze_intent(payload)
            self.log_test_result(
                "An√°lise de inten√ß√£o - SQL Query",
                intent_analysis.intent.value == "sql_query",
                f"Inten√ß√£o: {intent_analysis.intent.value}, Confian√ßa: {intent_analysis.confidence}"
            )
            
            # Teste 3: Gera√ß√£o de resposta
            response_text = await self.orchestrator.generate_response(
                "Teste de resposta",
                {"test": "data"},
                []
            )
            self.log_test_result(
                "Gera√ß√£o de resposta",
                len(response_text) > 0,
                f"Resposta gerada: {response_text[:100]}..."
            )
            
            # Teste 4: Processamento completo de mensagem
            payload.user_message = "Ol√°, preciso de ajuda"
            response = await self.orchestrator.process_message(payload)
            self.log_test_result(
                "Processamento completo de mensagem",
                response.success and len(response.response) > 0,
                f"Resposta: {response.response[:100]}..."
            )
            
        except Exception as e:
            self.log_test_result(
                "Orchestrator Agent (geral)",
                False,
                f"Erro: {str(e)}"
            )
    
    async def test_sql_agent(self):
        """Testa o agente SQL."""
        print("üß™ Testando SQL Agent...")
        
        try:
            # Teste 1: Gera√ß√£o de consulta SQL
            sql_output = await self.sql_agent.generate_sql_query(
                "Quantos usu√°rios temos?",
                {"table": "usuarios", "operation": "count"}
            )
            self.log_test_result(
                "Gera√ß√£o de consulta SQL",
                len(sql_output.sql_query) > 0 and "SELECT" in sql_output.sql_query.upper(),
                f"Query: {sql_output.sql_query[:100]}..."
            )
            
            # Teste 2: Valida√ß√£o de seguran√ßa
            is_safe, reason = self.sql_agent._validate_sql_safety("SELECT * FROM usuarios LIMIT 10")
            self.log_test_result(
                "Valida√ß√£o de seguran√ßa - Query segura",
                is_safe,
                f"Raz√£o: {reason}"
            )
            
            # Teste 3: Valida√ß√£o de seguran√ßa - Query perigosa
            is_safe, reason = self.sql_agent._validate_sql_safety("DROP TABLE usuarios")
            self.log_test_result(
                "Valida√ß√£o de seguran√ßa - Query perigosa",
                not is_safe,
                f"Raz√£o: {reason}"
            )
            
            # Teste 4: Execu√ß√£o completa (sem banco real)
            response = await self.sql_agent.execute_query(
                "Contar usu√°rios",
                {"operation": "count"},
                self.test_session_id
            )
            # Este teste pode falhar se n√£o houver banco configurado, mas n√£o deve gerar exce√ß√£o
            self.log_test_result(
                "Execu√ß√£o completa de query",
                True,  # Sucesso se n√£o houve exce√ß√£o
                f"Sucesso: {response.success}, Erro: {response.error}"
            )
            
        except Exception as e:
            self.log_test_result(
                "SQL Agent (geral)",
                False,
                f"Erro: {str(e)}"
            )
    
    async def test_integration(self):
        """Testa a integra√ß√£o completa do sistema."""
        print("üß™ Testando Integra√ß√£o Completa...")
        
        try:
            # Cen√°rio completo: usu√°rio faz pergunta, sistema processa e responde
            payload = WebhookPayload(
                session_id=f"integration_test_{int(datetime.now().timestamp())}",
                user_message="Ol√°! Voc√™ pode me ajudar com consultas de dados?",
                conversation_history=[]
            )
            
            # Processar atrav√©s do session manager
            processed_payload = await self.session_manager.process_webhook_payload(payload)
            
            # Processar atrav√©s do orquestrador
            response = await self.orchestrator.process_message(processed_payload)
            
            # Adicionar resposta ao hist√≥rico
            await self.session_manager.add_assistant_response(
                response.session_id,
                response.response,
                response.metadata
            )
            
            # Verificar se tudo funcionou
            final_history = await self.session_manager.get_conversation_history(response.session_id)
            
            self.log_test_result(
                "Integra√ß√£o completa",
                (response.success and 
                 len(response.response) > 0 and 
                 len(final_history) >= 2),  # Pelo menos user + assistant
                f"Resposta: {response.response[:100]}..., Hist√≥rico: {len(final_history)} mensagens"
            )
            
        except Exception as e:
            self.log_test_result(
                "Integra√ß√£o completa",
                False,
                f"Erro: {str(e)}"
            )
    
    def test_environment_setup(self):
        """Testa a configura√ß√£o do ambiente."""
        print("üß™ Testando Configura√ß√£o do Ambiente...")
        
        # Teste 1: Vari√°veis de ambiente
        openai_key = os.getenv("OPENAI_API_KEY")
        self.log_test_result(
            "OpenAI API Key configurada",
            openai_key is not None and len(openai_key) > 0,
            "Chave da OpenAI est√° configurada" if openai_key else "Chave da OpenAI n√£o encontrada"
        )
        
        # Teste 2: Importa√ß√µes
        try:
            import langchain
            import openai
            import fastapi
            import redis
            self.log_test_result(
                "Depend√™ncias importadas",
                True,
                "Todas as depend√™ncias principais foram importadas com sucesso"
            )
        except ImportError as e:
            self.log_test_result(
                "Depend√™ncias importadas",
                False,
                f"Erro ao importar depend√™ncias: {str(e)}"
            )
    
    def print_summary(self):
        """Imprime um resumo dos testes."""
        print("=" * 60)
        print("üìä RESUMO DOS TESTES")
        print("=" * 60)
        print(f"Total de testes: {self.test_results['total_tests']}")
        print(f"Testes aprovados: {self.test_results['passed_tests']}")
        print(f"Testes falharam: {self.test_results['failed_tests']}")
        
        if self.test_results['total_tests'] > 0:
            success_rate = (self.test_results['passed_tests'] / self.test_results['total_tests']) * 100
            print(f"Taxa de sucesso: {success_rate:.1f}%")
        
        print("\nüìã DETALHES DOS TESTES:")
        for test in self.test_results['test_details']:
            print(f"{test['status']}: {test['test_name']}")
            if test['details']:
                print(f"   {test['details']}")
        
        print("\n" + "=" * 60)
        
        if self.test_results['failed_tests'] == 0:
            print("üéâ Todos os testes passaram! O sistema est√° funcionando corretamente.")
        else:
            print("‚ö†Ô∏è  Alguns testes falharam. Verifique os detalhes acima.")
        
        print("=" * 60)
    
    async def run_all_tests(self):
        """Executa todos os testes."""
        print("üöÄ Iniciando testes do sistema de agentes orquestradores...")
        print("=" * 60)
        
        # Testes de configura√ß√£o
        self.test_environment_setup()
        
        # Testes de componentes individuais
        await self.test_session_manager()
        await self.test_orchestrator_agent()
        await self.test_sql_agent()
        
        # Teste de integra√ß√£o
        await self.test_integration()
        
        # Resumo final
        self.print_summary()


async def main():
    """Fun√ß√£o principal para executar os testes."""
    tester = SystemTester()
    await tester.run_all_tests()


if __name__ == "__main__":
    # Configurar vari√°veis de ambiente para teste se n√£o estiverem definidas
    if not os.getenv("OPENAI_API_KEY"):
        print("‚ö†Ô∏è  OPENAI_API_KEY n√£o configurada. Alguns testes podem falhar.")
        print("   Configure a vari√°vel de ambiente ou crie um arquivo .env")
        print()
    
    # Executar testes
    asyncio.run(main())
